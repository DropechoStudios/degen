<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <script src="dropecho.dungen.js"></script>
  <script src="dat.gui.min.js"></script>
    <title></title>
</head>

<body>
  <div>
    <textarea id="json" style=" height:500px; width:300px"></textarea>
  </div>

  <div style="position:absolute; top: 0px; left: 325px;">
    <canvas id="canvas" height="600" width="600"></canvas>
  </div>

  <div style="position:absolute; top: 0px; left: 925px;">
    <canvas id="cccanvas" height="600" width="600"></canvas>
  </div>
</body>
<script type="text/javascript">
  var map;
  var bsp = new dungen.BSPGenerator();
  var ctx = document.querySelector('#canvas').getContext('2d');
  var convChainMap;
  var convChainCtx = document.querySelector('#cccanvas').getContext('2d');
  var roomGenParams = {
    padding: 0
  };
  var caveGenParams = {
    steps: [{
      reps: 4,
      r1_cutoff: 5,
      r2_cutoff: 2,
      invert: true
    },
    {
      reps : 3,
      r1_cutoff: 5,
      r2_cutoff: 0,
      invert: true
    }
    ],
    height: 64,
    width: 64,
    tile_floor: 1,
    tile_wall: 0,
    start_fill_percent: 40
  };

  var convChainParams = {
	  width: 64,
    height: 64,
    n: 3,
    temperature:1,
    iterations:20
  };

  var mapScale = 4;

  var opts = {
    type: 'room',
    seed: '0',
    generateNewSeed: function (){
      opts.seed = Math.round(Math.random() * 99999999).toString();
      this.generate();
    },

    generateConvChainNewSeed: function() {
      this.generateConvChain(Math.round(Math.random() * 99999999).toString());
    },

    generateConvChain: function(seed = "0") {
      convChainCtx.clearRect(0,0,1024,1024);

      var gen = new dungen.ConvChain(map);
      gen.rng.setStringSeed(seed);
      var convChainMap = gen.generate(
        convChainParams.width,
        convChainParams.height,
        convChainParams.n,
        convChainParams.temperature,
        convChainParams.iterations,
      );

      console.log('what', convChainMap);

      convChainMap._mapData.forEach(function(tile,i){
        var pos = convChainMap.IndexToXY(i);
        convChainCtx.fillStyle = tile == 0 ? '#333' : "#aaa"; 
        convChainCtx.fillRect(pos.x*mapScale,pos.y*mapScale,mapScale,mapScale);
      });
    },

    generate: function (){
      switch(opts.type){
        case 'cave': 
          caveGenParams.seed = opts.seed;
          map = dungen.CAGenerator.generate(caveGenParams);
          break;
        case 'walk': 
          caveGenParams.seed = opts.seed;
          map = dungen.WalkGenerator.generate(caveGenParams);
          break;
        case 'random': 
          caveGenParams.seed = opts.seed;
          map = dungen.RandomGenerator.generate(caveGenParams);
          break;
        case 'mixed': 
          bsp.seed = opts.seed;
          map = dungen.MixedGenerator.buildRooms(bsp.generate(), roomGenParams);
          break;
        case 'room': 
          bsp.seed = opts.seed;
          map = dungen.RoomGenerator.buildRooms(bsp.generate(), roomGenParams);
          break;
      }
      convChainCtx.clearRect(0,0,1024,1024);
      ctx.clearRect(0,0,1024,1024);

      map._mapData.forEach(function(tile,i){
        var pos = map.IndexToXY(i);
        ctx.fillStyle = tile == 0 ? '#333' : "#aaa"; 
        ctx.fillRect(pos.x*mapScale,pos.y*mapScale,mapScale,mapScale);
      });
    },
    generateJson: function(){
      var json = dungen.TiledExporter.export(map);
      document.querySelector('#json').value = json;
    }
  };

  var gui = new dat.GUI();
  gui.add(opts, 'type', ['room', 'cave', 'walk', 'random', 'mixed']);
  gui.add(opts, 'seed', "0").listen();

  (function addRoomGui(){
    var roomGui = gui.addFolder('room') 
    roomGui.add(bsp, 'width', 16, 128).step(1);
    roomGui.add(bsp, 'height', 16, 128).step(1);
    roomGui.add(bsp, 'minWidth', 2, 32).step(1);
    roomGui.add(bsp, 'minHeight', 2, 32).step(1);
    roomGui.add(bsp, 'depth', 1, 10).step(1);
    roomGui.add(bsp, 'ratio', 0, 1).step(0.1);
    roomGui.add(roomGenParams, 'padding', 0, 16).step(1);
  })();

  (function addCaveGui(){
    var caveGui = gui.addFolder('cave');
    caveGui.add(caveGenParams, 'width', 16, 128);
    caveGui.add(caveGenParams, 'height', 16, 128);

    var step1 = caveGui.addFolder('step1') 
    step1.add(caveGenParams.steps[0], 'reps', 1, 10).step(1);
    step1.add(caveGenParams.steps[0], 'r1_cutoff', 0, 10).step(1);
    step1.add(caveGenParams.steps[0], 'r2_cutoff', 0, 10).step(1);
    step1.add(caveGenParams.steps[0], 'invert')

    var step2 = caveGui.addFolder('step2') 
    step2.add(caveGenParams.steps[1], 'reps', 1, 10).step(1);
    step2.add(caveGenParams.steps[1], 'r1_cutoff', 0, 10).step(1);
    step2.add(caveGenParams.steps[1], 'r2_cutoff', 0, 10).step(1);
    step2.add(caveGenParams.steps[1], 'invert')
  })();

  var convchaingui = gui.addFolder('ConvChain');
  convchaingui.add(convChainParams, 'width', 16, 128);
  convchaingui.add(convChainParams, 'height', 16, 128);
  convchaingui.add(convChainParams, 'n', 2, 8).step(1);

  gui.add(opts, 'generate');
  gui.add(opts, 'generateNewSeed');
  gui.add(opts, 'generateConvChain');
  gui.add(opts, 'generateConvChainNewSeed');
  gui.add(opts, 'generateJson');


</script>

</html>
