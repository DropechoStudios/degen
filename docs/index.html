<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <script src="dungen.js"></script>
  <script src="dat.gui.min.js"></script>
    <title></title>
</head>

<body>
  <div>
    <textarea id="json" style=" height:500px; width:300px"></textarea>
  </div>

  <div style="position:absolute; top: 0px; left: 400px;">
    <canvas id="canvas" height="1024" width="1024"></canvas>
  </div>
</body>
<script type="text/javascript">
  var map;
  var bsp = new dungen.BSPGenerator();
  var ctx = document.querySelector('canvas').getContext('2d');
  var roomGenParams = {
  };
  var caveGenParams = {
    steps: [{
      reps: 6,
      r1_cutoff: 5,
      r2_cutoff: 2
    },
    {
      reps : 6,
      r1_cutoff: 5,
      r2_cutoff: -1
    }
    ],
    height: 64,
    width: 64,
    tile_floor: 1,
    tile_wall: 0,
    start_fill_percent: 40
  };

  var mapScale = 10;

  var opts = {
    type: 'room',
    generate: function (){
      switch(opts.type){
        case 'cave': 
          map = dungen.CAGenerator.generate(caveGenParams);
          break;
        case 'walk': 
          map = dungen.WalkGenerator.generate(caveGenParams);
          break;
        case 'room': 
          map = dungen.RoomGenerator.buildRooms(bsp.generate(), roomGenParams);
          break;
      }
      ctx.clearRect(0,0,1024,1024);

      map._mapData.forEach(function(tile,i){
        var pos = map.IndexToXY(i);
        ctx.fillStyle = tile == 1 ? '#aaffaa' : "#aaa"; 
        if(tile == 0){
          var n1 = map.getNeighborCount(pos.x, pos.y, 0, 1);
          var n3 = map.getNeighborCount(pos.x, pos.y, 0, 3);
          color = 216 - (n3 * 4);
          ctx.fillStyle = 'rgb(' + color +',' + color +',' + color +')';
        } else {
          var nWalls = map.getNeighborCount(pos.x, pos.y, 0, 1);
          var nFloor = map.getNeighborCount(pos.x, pos.y, 1, 1);
          var nWalls2 = map.getNeighborCount(pos.x, pos.y, 0, 2);
          var nFloor2 = map.getNeighborCount(pos.x, pos.y, 1, 2);

          //var color = 192 - (nWalls - nFloor * 8); 
          //color += nFloor * 8;

          //ctx.fillStyle = 'rgb(' + color + 2 +',' + color +',' + color +')';
        }
        ctx.fillRect(pos.x*mapScale,pos.y*mapScale,mapScale,mapScale);
      });
    },
    generateJson: function(){
      var json = dungen.TiledExporter.export(map);
      document.querySelector('#json').value = json;
    }
  };

  var gui = new dat.GUI();
  gui.add(opts, 'type', ['room', 'cave', 'walk']);

  (function addRoomGui(){
    var roomGui = gui.addFolder('room') 
    roomGui.add(bsp, 'width', 16, 128).step(1);
    roomGui.add(bsp, 'height', 16, 128).step(1);
    roomGui.add(bsp, 'minWidth', 2, 32).step(1);
    roomGui.add(bsp, 'minHeight', 2, 32).step(1);
    roomGui.add(bsp, 'depth', 1, 10).step(1);
    roomGui.add(bsp, 'ratio', 0, 1).step(0.1);
    //roomGui.add(roomGenParams, 'padding', 0, 16).step(1);
  })();

  (function addCaveGui(){
    var caveGui = gui.addFolder('cave') 
    caveGui.add(caveGenParams, 'width', 16, 128);
    caveGui.add(caveGenParams, 'height', 16, 128);

    var step1 = caveGui.addFolder('step1') 
    step1.add(caveGenParams.steps[0], 'reps', 1, 10).step(1);
    step1.add(caveGenParams.steps[0], 'r1_cutoff', 0, 10).step(1);
    step1.add(caveGenParams.steps[0], 'r2_cutoff', 0, 10).step(1);

    var step2 = caveGui.addFolder('step2') 
    step2.add(caveGenParams.steps[0], 'reps', 1, 10).step(1);
    step2.add(caveGenParams.steps[0], 'r1_cutoff', 0, 10).step(1);
    step2.add(caveGenParams.steps[0], 'r2_cutoff', 0, 10).step(1);
  })();

  gui.add(opts, 'generate');
  gui.add(opts, 'generateJson');


</script>

</html>
